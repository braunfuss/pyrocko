<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Forward Modeling synthetic seismograms and displacements &#8212; Pyrocko v0.3 Manual</title>
    
    <link rel="stylesheet" href="../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Pyrocko v0.3 Manual"
          href="../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Accessing crustal velocity databases" href="velocity_databases.html" />
    <link rel="prev" title="Calculation of Green’s function databases" href="gf_store.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
    

  </head>
  <body role="document">
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="../../index.html">Pyrocko v0.3 Manual</a> &#187;</li>
          <li><a href="../index.html" >Library</a> &#187;</li>
          <li><a href="index.html" accesskey="U">Examples</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="forward-modeling-synthetic-seismograms-and-displacements">
<h1>Forward Modeling synthetic seismograms and displacements<a class="headerlink" href="#forward-modeling-synthetic-seismograms-and-displacements" title="Permalink to this headline">¶</a></h1>
<div class="section" id="calculate-synthetic-seismograms-from-a-local-store">
<h2>Calculate synthetic seismograms from a local store<a class="headerlink" href="#calculate-synthetic-seismograms-from-a-local-store" title="Permalink to this headline">¶</a></h2>
<p>It is assumed that a <a class="reference internal" href="../reference/gf.html#pyrocko.gf.store.Store" title="pyrocko.gf.store.Store"><code class="xref py py-class docutils literal"><span class="pre">Store</span></code></a> with store ID
<em>crust2_dd</em> has been downloaded in advance. A list of currently available
stores can be found at <a class="reference external" href="http://kinherd.org/gfs.html">http://kinherd.org/gfs.html</a> as well as how to download
such stores.</p>
<p>Further API documentation for the utilized objects can be found at <a class="reference internal" href="../reference/gf.html#pyrocko.gf.targets.Target" title="pyrocko.gf.targets.Target"><code class="xref py py-class docutils literal"><span class="pre">Target</span></code></a>,
<a class="reference internal" href="../reference/gf.html#pyrocko.gf.seismosizer.LocalEngine" title="pyrocko.gf.seismosizer.LocalEngine"><code class="xref py py-class docutils literal"><span class="pre">LocalEngine</span></code></a> and <a class="reference internal" href="../reference/gf.html#pyrocko.gf.seismosizer.DCSource" title="pyrocko.gf.seismosizer.DCSource"><code class="xref py py-class docutils literal"><span class="pre">DCSource</span></code></a>.</p>
<p><a class="reference download internal" href="../../_downloads/gf_forward_example1.py" download=""><code class="xref download docutils literal"><span class="pre">gf_forward_example1.py</span></code></a></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko.gf</span> <span class="kn">import</span> <span class="n">LocalEngine</span><span class="p">,</span> <span class="n">Target</span><span class="p">,</span> <span class="n">DCSource</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">trace</span>
<span class="kn">from</span> <span class="nn">pyrocko.gui_util</span> <span class="kn">import</span> <span class="n">PhaseMarker</span>

<span class="c1"># We need a pyrocko.gf.Engine object which provides us with the traces</span>
<span class="c1"># extracted from the store. In this case we are going to use a local</span>
<span class="c1"># engine since we are going to query a local store.</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">LocalEngine</span><span class="p">(</span><span class="n">store_superdirs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;/media/usb/gf_stores&#39;</span><span class="p">])</span>

<span class="c1"># The store we are going extract data from:</span>
<span class="n">store_id</span> <span class="o">=</span> <span class="s1">&#39;crust2_dd&#39;</span>

<span class="c1"># Define a list of pyrocko.gf.Target objects, representing the recording</span>
<span class="c1"># devices. In this case one station with a three component sensor will</span>
<span class="c1"># serve fine for demonstation.</span>
<span class="n">channel_codes</span> <span class="o">=</span> <span class="s1">&#39;ENZ&#39;</span>
<span class="n">targets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Target</span><span class="p">(</span>
        <span class="n">lat</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
        <span class="n">lon</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
        <span class="n">store_id</span><span class="o">=</span><span class="n">store_id</span><span class="p">,</span>
        <span class="n">codes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;STA&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">channel_code</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">channel_code</span> <span class="ow">in</span> <span class="n">channel_codes</span><span class="p">]</span>

<span class="c1"># Let&#39;s use a double couple source representation.</span>
<span class="n">source_dc</span> <span class="o">=</span> <span class="n">DCSource</span><span class="p">(</span>
    <span class="n">lat</span><span class="o">=</span><span class="mf">11.</span><span class="p">,</span>
    <span class="n">lon</span><span class="o">=</span><span class="mf">11.</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mf">10000.</span><span class="p">,</span>
    <span class="n">strike</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span>
    <span class="n">dip</span><span class="o">=</span><span class="mf">40.</span><span class="p">,</span>
    <span class="n">rake</span><span class="o">=</span><span class="mf">60.</span><span class="p">,</span>
    <span class="n">magnitude</span><span class="o">=</span><span class="mf">4.</span><span class="p">)</span>

<span class="c1"># Processing that data will return a pyrocko.gf.Reponse object.</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">source_dc</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

<span class="c1"># This will return a list of the requested traces:</span>
<span class="n">synthetic_traces</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">pyrocko_traces</span><span class="p">()</span>

<span class="c1"># In addition to that it is also possible to extract interpolated travel times</span>
<span class="c1"># of phases which have been defined in the store&#39;s config file.</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">store_id</span><span class="p">)</span>

<span class="n">markers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">source_dc</span><span class="p">)</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">source_dc</span><span class="o">.</span><span class="n">depth</span>
    <span class="n">arrival_time</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s1">&#39;any_P&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">dist</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">PhaseMarker</span><span class="p">(</span><span class="n">tmin</span><span class="o">=</span><span class="n">arrival_time</span><span class="p">,</span>
                    <span class="n">tmax</span><span class="o">=</span><span class="n">arrival_time</span><span class="p">,</span>
                    <span class="n">phasename</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">,</span>
                    <span class="n">nslc_ids</span><span class="o">=</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">codes</span><span class="p">,))</span>
    <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1"># Finally, let&#39;s scrutinize these traces.</span>
<span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">synthetic_traces</span><span class="p">,</span> <span class="n">markers</span><span class="o">=</span><span class="n">markers</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center" id="id1">
<img alt="Synthetic seismograms calculated through pyrocko.gf" src="../../_images/gf_synthetic.png" />
<p class="caption"><span class="caption-text">Synthetic seismograms calculated through <a class="reference internal" href="../reference/gf.html#module-pyrocko.gf" title="pyrocko.gf"><code class="xref py py-class docutils literal"><span class="pre">pyrocko.gf</span></code></a> displayed in <a class="reference internal" href="../../apps/snuffler/index.html"><span class="doc">Snuffler</span></a>. The three traces show the east, north and vertical synthetical displacement stimulated by a double-couple source at 155 km distance.</span></p>
</div>
</div>
<div class="section" id="calculate-spatial-surface-displacement-from-a-local-store">
<h2>Calculate spatial surface displacement from a local store<a class="headerlink" href="#calculate-spatial-surface-displacement-from-a-local-store" title="Permalink to this headline">¶</a></h2>
<p>In this example we create a <a class="reference internal" href="../reference/gf.html#pyrocko.gf.seismosizer.RectangularSource" title="pyrocko.gf.seismosizer.RectangularSource"><code class="xref py py-class docutils literal"><span class="pre">RectangularSource</span></code></a> and compute the spatial static/geodetic displacement caused by that rupture.</p>
<p>We will utilize <a class="reference internal" href="../reference/gf.html#pyrocko.gf.seismosizer.LocalEngine" title="pyrocko.gf.seismosizer.LocalEngine"><code class="xref py py-class docutils literal"><span class="pre">LocalEngine</span></code></a>, <a class="reference internal" href="../reference/gf.html#pyrocko.gf.targets.StaticTarget" title="pyrocko.gf.targets.StaticTarget"><code class="xref py py-class docutils literal"><span class="pre">StaticTarget</span></code></a> and <a class="reference internal" href="../reference/gf.html#pyrocko.gf.targets.SatelliteTarget" title="pyrocko.gf.targets.SatelliteTarget"><code class="xref py py-class docutils literal"><span class="pre">SatelliteTarget</span></code></a>.</p>
<div class="figure align-center" id="id2">
<img alt="Static displacement from a strike-slip fault calculated through pyrocko" src="../../_images/gf_static_displacement.png" />
<p class="caption"><span class="caption-text">Synthetic surface displacement from a vertical strike-slip fault, with a N104W azimuth, in the Line-of-sight (LOS), east, north and vertical directions. LOS as for Envisat satellite (Look Angle: 23., Heading:-76). Positive motion toward the satellite.</span></p>
</div>
<p><a class="reference download internal" href="../../_downloads/gf_forward_example2.py" download=""><code class="xref download docutils literal"><span class="pre">gf_forward_example2.py</span></code></a></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko.gf</span> <span class="kn">import</span> <span class="n">LocalEngine</span><span class="p">,</span> <span class="n">SatelliteTarget</span><span class="p">,</span> <span class="n">RectangularSource</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">num</span>

<span class="c1"># distance in kilometer</span>
<span class="n">km</span> <span class="o">=</span> <span class="mf">1e3</span>

<span class="c1"># Ignite the LocalEngine and point it to fomosto stores stored on a</span>
<span class="c1"># USB stick, for this example we use a static store with id &#39;static_store&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">LocalEngine</span><span class="p">(</span><span class="n">store_superdirs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;/media/usb/stores&#39;</span><span class="p">])</span>
<span class="n">store_id</span> <span class="o">=</span> <span class="s1">&#39;static_store&#39;</span>

<span class="c1"># We define an extended source, in this case a rectangular geometry</span>
<span class="c1"># Centroid UTM position is defined relatively to geographical lat, lon position</span>
<span class="c1"># Purely lef-lateral strike-slip fault with an N104W azimuth.</span>
<span class="n">rect_source</span> <span class="o">=</span> <span class="n">RectangularSource</span><span class="p">(</span>
    <span class="n">lat</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
    <span class="n">north_shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">east_shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mf">6.5</span><span class="o">*</span><span class="n">km</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">km</span><span class="p">,</span>
    <span class="n">dip</span><span class="o">=</span><span class="mf">90.</span><span class="p">,</span> <span class="n">rake</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">strike</span><span class="o">=</span><span class="mf">104.</span><span class="p">,</span>
    <span class="n">slip</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

<span class="c1"># We will define 1000 randomly distributed targets.</span>
<span class="n">ntargets</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># We initialize the satellite target and set the line of sight vectors</span>
<span class="c1"># direction, example of the Envisat satellite</span>
<span class="n">look</span> <span class="o">=</span> <span class="mf">23.</span>     <span class="c1"># angle between the LOS and the vertical</span>
<span class="n">heading</span> <span class="o">=</span> <span class="o">-</span><span class="mi">76</span>  <span class="c1"># angle between the azimuth and the east (anti-clock)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ntargets</span><span class="p">)</span>  <span class="c1"># vertical LOS from horizontal</span>
<span class="n">theta</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">90.</span> <span class="o">-</span> <span class="n">look</span><span class="p">))</span>
<span class="n">phi</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ntargets</span><span class="p">)</span>  <span class="c1"># horizontal LOS from E in anti-clokwise rotation</span>
<span class="n">phi</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="o">-</span><span class="n">heading</span><span class="p">))</span>

<span class="n">satellite_target</span> <span class="o">=</span> <span class="n">SatelliteTarget</span><span class="p">(</span>
    <span class="n">north_shifts</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">ntargets</span><span class="p">)</span><span class="o">-.</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">30.</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
    <span class="n">east_shifts</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">ntargets</span><span class="p">)</span><span class="o">-.</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">30.</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
    <span class="n">tsnapshot</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">,</span>
    <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
    <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span>
    <span class="n">store_id</span><span class="o">=</span><span class="n">store_id</span><span class="p">)</span>

<span class="c1"># The computation is performed by calling process on the engine</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">rect_source</span><span class="p">,</span> <span class="p">[</span><span class="n">satellite_target</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">plot_static_los_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Helper function for plotting the displacement&#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">coords5</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">coords5</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">result</span>

    <span class="c1"># get the component names</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">vranges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">dspl</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">vrange</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">vranges</span><span class="p">):</span>

        <span class="n">lmax</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">([</span><span class="n">num</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vrange</span><span class="p">),</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vrange</span><span class="p">)])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">lmax</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

        <span class="c1"># plot interpolated points in map view with tricontourf</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">dspl</span><span class="p">],</span>
                              <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;seismic&#39;</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">dspl</span><span class="o">+</span><span class="s1">&#39; [m]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

        <span class="c1"># We plot the modeled fault</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">rect_source</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_static_los_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="calculate-forward-model-of-thrust-event-and-display-wrapped-phase">
<h2>Calculate forward model of thrust event and display wrapped phase<a class="headerlink" href="#calculate-forward-model-of-thrust-event-and-display-wrapped-phase" title="Permalink to this headline">¶</a></h2>
<p>In this example we compare the synthetic unwappred and wrapped LOS displacements caused by a thrust rupture.</p>
<div class="figure align-center" id="id3">
<img alt="Static displacement from a thrust fault calculated through pyrocko" src="../../_images/gf_static_wrapper.png" />
<p class="caption"><span class="caption-text">Synthetic LOS displacements from a south-dipping thrust fault. LOS as for Sentinel-1 satellite (Look Angle: 36., Heading:-76). Positive motion toward the satellite. Left: unwrapped phase. Right: Wrapped phase.</span></p>
</div>
<p><a class="reference download internal" href="../../_downloads/gf_forward_example3.py" download=""><code class="xref download docutils literal"><span class="pre">gf_forward_example3.py</span></code></a></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko.gf</span> <span class="kn">import</span> <span class="n">LocalEngine</span><span class="p">,</span> <span class="n">SatelliteTarget</span><span class="p">,</span> <span class="n">RectangularSource</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">num</span>

<span class="c1"># distance in kilometer</span>
<span class="n">km</span> <span class="o">=</span> <span class="mf">1e3</span>

<span class="c1"># Ignite the LocalEngine and point it to fomosto stores stored on a</span>
<span class="c1"># USB stick, for this example we use a static store with id &#39;static_store&#39;</span>
<span class="n">store_id</span> <span class="o">=</span> <span class="s1">&#39;static_store&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">LocalEngine</span><span class="p">(</span><span class="n">store_superdirs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;/media/usb/gf_stores&#39;</span><span class="p">])</span>

<span class="c1"># We want to reproduce the USGS Solution of the event</span>
<span class="n">d</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">rake</span><span class="p">,</span> <span class="n">slip</span> <span class="o">=</span> <span class="mf">10.5</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">40.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">5.</span>

<span class="c1"># We compute the magnitude of the event</span>
<span class="n">potency</span> <span class="o">=</span> <span class="n">l</span><span class="o">*</span><span class="n">km</span><span class="o">*</span><span class="n">W</span><span class="o">*</span><span class="n">km</span><span class="o">*</span><span class="n">slip</span>
<span class="n">m0</span> <span class="o">=</span> <span class="n">potency</span><span class="o">*</span><span class="mf">31.5e9</span>
<span class="n">mw</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">m0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">6.07</span>

<span class="c1"># We define an extended source, in this case a rectangular geometry</span>
<span class="c1"># horizontal distance</span>
<span class="c1"># The centorid north position depends on its dip angle and its width.</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">dip</span><span class="p">))</span><span class="o">*</span><span class="n">W</span><span class="o">/</span><span class="mi">2</span>

<span class="n">thrust</span> <span class="o">=</span> <span class="n">RectangularSource</span><span class="p">(</span>
    <span class="n">north_shift</span><span class="o">=</span><span class="n">n</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="n">east_shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="n">d</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">W</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">l</span><span class="o">*</span><span class="n">km</span><span class="p">,</span>
    <span class="n">dip</span><span class="o">=</span><span class="n">dip</span><span class="p">,</span> <span class="n">rake</span><span class="o">=</span><span class="n">rake</span><span class="p">,</span> <span class="n">strike</span><span class="o">=</span><span class="n">strike</span><span class="p">,</span>
    <span class="n">slip</span><span class="o">=</span><span class="n">slip</span><span class="p">)</span>

<span class="c1"># We define a grid for the targets.</span>
<span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="o">-</span><span class="mi">15</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="mi">15</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="mi">15</span><span class="o">*</span><span class="n">km</span>
<span class="n">ntargets</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># We initialize the satellite target and set the line of site vectors</span>
<span class="c1"># Case example of the Sentinel-1 satellite:</span>
<span class="c1"># Heading: -166 (anti clokwise rotation from east)</span>
<span class="c1"># Average Look Angle: 36 (from vertical)</span>
<span class="n">heading</span> <span class="o">=</span> <span class="o">-</span><span class="mf">76.</span>
<span class="n">look</span> <span class="o">=</span> <span class="mf">36.</span>
<span class="n">phi</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ntargets</span><span class="p">)</span>    <span class="c1"># Horizontal LOS from E in anti-clokwise rotation</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ntargets</span><span class="p">)</span>  <span class="c1"># Vertical LOS from horizontal</span>
<span class="n">phi</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="o">-</span><span class="n">heading</span><span class="p">))</span>
<span class="n">theta</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">90.</span><span class="o">-</span><span class="n">look</span><span class="p">))</span>

<span class="n">satellite_target</span> <span class="o">=</span> <span class="n">SatelliteTarget</span><span class="p">(</span>
    <span class="n">north_shifts</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">ntargets</span><span class="p">),</span>
    <span class="n">east_shifts</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">ntargets</span><span class="p">),</span>
    <span class="n">tsnapshot</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">,</span>
    <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
    <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span>
    <span class="n">store_id</span><span class="o">=</span><span class="n">store_id</span><span class="p">)</span>

<span class="c1"># The computation is performed by calling process on the engine</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">thrust</span><span class="p">,</span> <span class="p">[</span><span class="n">satellite_target</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">plot_static_los_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Helper function for plotting the displacement&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

    <span class="c1"># get forward model from engine</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">coords5</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">coords5</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">result</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
        <span class="s2">&quot;thrust: depth={:0.2f}, l={}, w={:0.2f},strike={}, &quot;</span>
        <span class="s2">&quot;rake={}, dip={}, slip={}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;heading={}, look angle={}, Mw={:0.3f}&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">rake</span><span class="p">,</span> <span class="n">dip</span><span class="p">,</span> <span class="n">slip</span><span class="p">,</span> <span class="n">heading</span><span class="p">,</span> <span class="n">look</span><span class="p">,</span> <span class="n">mw</span><span class="p">),</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
        <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># Plot unwrapped LOS displacements</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># We shift the relative LOS displacements</span>
    <span class="n">los</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.los&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.los&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">losrange</span> <span class="o">=</span> <span class="p">[(</span><span class="n">los</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">los</span><span class="o">.</span><span class="n">min</span><span class="p">())]</span>
    <span class="n">losmax</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">([</span><span class="n">num</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">losrange</span><span class="p">),</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">losrange</span><span class="p">)])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">losmax</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span>
        <span class="n">E</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;seismic&#39;</span><span class="p">),</span>
        <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;los&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

    <span class="c1"># We plot the fault projection to the surface</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">thrust</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># We underline the tip of the thrust</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">n</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># We plot wrapped phase</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># We wrap the phase between 0 and 0.028 mm</span>
    <span class="n">wavelenght</span> <span class="o">=</span> <span class="mf">0.028</span>
    <span class="n">wrapped_los</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">wavelenght</span><span class="p">)</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">wavelenght</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="c1"># ax.tricontour(E, N, wrapped_los,</span>
    <span class="c1">#   map=&#39;gist_rainbow&#39;, levels=levels, colors=&#39;k&#39;)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span>
        <span class="n">E</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">wrapped_los</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;gist_rainbow&#39;</span><span class="p">),</span>
        <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bicubic&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;wrapped los&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

    <span class="c1"># We plot the fault projection to the surface</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">thrust</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># We underline the tiip of the fault</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">n</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_static_los_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="combining-severals-sources">
<h2>Combining severals sources<a class="headerlink" href="#combining-severals-sources" title="Permalink to this headline">¶</a></h2>
<p>In this example we combine two rectangular sources and plot the forward model in profile.</p>
<div class="figure align-center" id="id4">
<img alt="../../_images/gf_static_several.png" src="../../_images/gf_static_several.png" />
<p class="caption"><span class="caption-text">Synthetic LOS displacements from a flower-structure made of one strike-slip
fault and one thrust fault. LOS as for Sentinel-1 satellite (Look Angle:
36., Heading:-76). Positive motion toward the satellite.</span></p>
</div>
<p><a class="reference download internal" href="../../_downloads/gf_forward_example4.py" download=""><code class="xref download docutils literal"><span class="pre">gf_forward_example4.py</span></code></a></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyrocko.gf</span> <span class="kn">import</span> <span class="n">LocalEngine</span><span class="p">,</span> <span class="n">SatelliteTarget</span><span class="p">,</span> <span class="n">RectangularSource</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">num</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="kn">import</span> <span class="n">gf</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="kn">import</span> <span class="n">List</span>

<span class="n">km</span> <span class="o">=</span> <span class="mf">1e3</span>


<span class="k">class</span> <span class="nc">CombiSource</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">Source</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Composite source model.&#39;&#39;&#39;</span>

    <span class="n">discretized_source_class</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">DiscretizedMTSource</span>

    <span class="n">subsources</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="n">T</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsources</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">subsources</span><span class="p">:</span>

            <span class="n">lats</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">subsource</span><span class="o">.</span><span class="n">lat</span> <span class="k">for</span> <span class="n">subsource</span> <span class="ow">in</span> <span class="n">subsources</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">subsource</span><span class="o">.</span><span class="n">lon</span> <span class="k">for</span> <span class="n">subsource</span> <span class="ow">in</span> <span class="n">subsources</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lats</span> <span class="o">==</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">num</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lons</span> <span class="o">==</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># if not same use:</span>
            <span class="c1"># lat, lon = center_latlon(subsources)</span>

            <span class="n">depth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">depth</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">subsources</span><span class="p">]))</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">time</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">subsources</span><span class="p">]))</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="n">lon</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span>

        <span class="n">gf</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsources</span><span class="o">=</span><span class="n">subsources</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="k">def</span> <span class="nf">discretize_basesource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">dsources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
        <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsources</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">sf</span><span class="o">.</span><span class="n">time</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">discretize_basesource</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">m6s</span> <span class="o">*=</span> <span class="n">sf</span><span class="o">.</span><span class="n">get_factor</span><span class="p">()</span>
            <span class="n">dsources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gf</span><span class="o">.</span><span class="n">DiscretizedMTSource</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">dsources</span><span class="p">)</span>

<span class="c1"># distance in kilometer</span>
<span class="n">km</span> <span class="o">=</span> <span class="mf">1e3</span>
<span class="c1"># We define a grid for the targets.</span>
<span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">km</span>
<span class="n">ntargets</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># Ignite the LocalEngine and point it to fomosto stores stored on a</span>
<span class="c1"># USB stick, for this example we use a static store with id &#39;static_store&#39;</span>
<span class="n">store_id</span> <span class="o">=</span> <span class="s1">&#39;static_store&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">LocalEngine</span><span class="p">(</span><span class="n">store_superdirs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;/media/usb/gf_stores&#39;</span><span class="p">])</span>

<span class="c1"># We define two finite sources</span>
<span class="c1"># The first one is a purely vertical strike-slip fault</span>
<span class="n">strikeslip</span> <span class="o">=</span> <span class="n">RectangularSource</span><span class="p">(</span>
    <span class="n">north_shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">east_shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">km</span><span class="p">,</span>
    <span class="n">dip</span><span class="o">=</span><span class="mf">90.</span><span class="p">,</span> <span class="n">rake</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">strike</span><span class="o">=</span><span class="mf">90.</span><span class="p">,</span>
    <span class="n">slip</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

<span class="c1"># The second one is a ramp connecting to the root of the strike-slip fault</span>
<span class="c1"># ramp north shift (n) and width (w) depend on its dip angle and on</span>
<span class="c1"># the strike slip fault width</span>
<span class="n">n</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span><span class="o">/</span><span class="n">num</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">45.</span><span class="p">)),</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">45.</span><span class="p">))))</span>
<span class="n">thrust</span> <span class="o">=</span> <span class="n">RectangularSource</span><span class="p">(</span>
    <span class="n">north_shift</span><span class="o">=</span><span class="n">n</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="n">east_shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">km</span><span class="p">,</span>
    <span class="n">dip</span><span class="o">=</span><span class="mf">45.</span><span class="p">,</span> <span class="n">rake</span><span class="o">=</span><span class="mf">90.</span><span class="p">,</span> <span class="n">strike</span><span class="o">=</span><span class="mf">90.</span><span class="p">,</span>
    <span class="n">slip</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># We initialize the satellite target and set the line of site vectors</span>
<span class="c1"># Case example of the Sentinel-1 satellite:</span>
<span class="c1"># Heading: -166 (anti clokwise rotation from east)</span>
<span class="c1"># Average Look Angle: 36 (from vertical)</span>
<span class="n">heading</span> <span class="o">=</span> <span class="o">-</span><span class="mi">76</span>
<span class="n">look</span> <span class="o">=</span> <span class="mf">36.</span>
<span class="n">phi</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ntargets</span><span class="p">)</span>    <span class="c1"># Horizontal LOS from E in anti-clokwise rotation</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ntargets</span><span class="p">)</span>  <span class="c1"># Vertical LOS from horizontal</span>
<span class="n">phi</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span> <span class="o">-</span> <span class="n">heading</span><span class="p">))</span>
<span class="n">theta</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">90.</span> <span class="o">-</span> <span class="n">look</span><span class="p">))</span>

<span class="n">satellite_target</span> <span class="o">=</span> <span class="n">SatelliteTarget</span><span class="p">(</span>
    <span class="n">north_shifts</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">ntargets</span><span class="p">),</span>
    <span class="n">east_shifts</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">ntargets</span><span class="p">),</span>
    <span class="n">tsnapshot</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">,</span>
    <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
    <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span>
    <span class="n">store_id</span><span class="o">=</span><span class="n">store_id</span><span class="p">)</span>

<span class="c1"># We combine the two sources here</span>
<span class="n">patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">strikeslip</span><span class="p">,</span> <span class="n">thrust</span><span class="p">]</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">CombiSource</span><span class="p">(</span><span class="n">subsources</span><span class="o">=</span><span class="n">patches</span><span class="p">)</span>

<span class="c1"># The computation is performed by calling process on the engine</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="p">[</span><span class="n">satellite_target</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">plot_static_los_profile</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="kn">as</span> <span class="nn">cm</span>
    <span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="kn">as</span> <span class="nn">mcolors</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># strike,l,w,x0,y0: strike, length, width, x, and y position</span>
    <span class="c1"># of the profile</span>
    <span class="n">strike</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">strike</span><span class="p">)</span>
    <span class="c1"># We define the parallel and perpendicular vectors to the profile</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">strike</span><span class="p">),</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">strike</span><span class="p">)]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">strike</span><span class="p">),</span> <span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">strike</span><span class="p">)]</span>

    <span class="c1"># We define the boundaries of the profile</span>
    <span class="n">ypmax</span><span class="p">,</span> <span class="n">ypmin</span> <span class="o">=</span> <span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">xpmax</span><span class="p">,</span> <span class="n">xpmin</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1"># We define the corners of the profile</span>
    <span class="n">xpro</span><span class="p">,</span> <span class="n">ypro</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">7</span><span class="p">)),</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">xpro</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">x0</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
        <span class="n">x0</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
        <span class="n">x0</span><span class="o">-</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="o">+</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">ypro</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">y0</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y0</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
        <span class="n">y0</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y0</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y0</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> \
        <span class="n">y0</span><span class="o">-</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y0</span><span class="o">+</span><span class="n">l</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># We get the forward model from the engine</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords5</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords5</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">result</span>

    <span class="c1"># We first plot the surface displacements in map view</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">los</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.los&#39;</span><span class="p">]</span>
    <span class="c1"># losrange = [(los.max(),los.min())]</span>
    <span class="c1"># losmax = num.abs([num.min(losrange), num.max(losrange)]).max()</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">los</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">los</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">50</span><span class="p">)</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;seismic&#39;</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">sourcess</span> <span class="ow">in</span> <span class="n">patches</span><span class="p">:</span>
        <span class="n">fn</span><span class="p">,</span> <span class="n">fe</span> <span class="o">=</span> <span class="n">sourcess</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">fe</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fe</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">fn</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># We plot the limits of the profile in map view</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpro</span><span class="p">[:],</span> <span class="n">ypro</span><span class="p">[:],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="c1"># plot colorbar</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Map view&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

    <span class="c1"># We plot displacements in profile</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># We compute the perpandicular and parallel components in the profile basis</span>
    <span class="n">yp</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">los</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.los&#39;</span><span class="p">]</span>

    <span class="c1"># We select data encompassing the profile</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
        <span class="p">(</span><span class="n">xp</span> <span class="o">&gt;</span> <span class="n">xpmax</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">xp</span> <span class="o">&lt;</span> <span class="n">xpmin</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">yp</span> <span class="o">&gt;</span> <span class="n">ypmax</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">yp</span> <span class="o">&lt;</span> <span class="n">ypmin</span><span class="p">))</span>

    <span class="n">ypp</span><span class="p">,</span> <span class="n">losp</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">yp</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span> \
        <span class="n">num</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="c1"># We associate the same color scale to the scatter plot</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">los</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">los</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;seismic&#39;</span><span class="p">))</span>
    <span class="n">facelos</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">losp</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">ypp</span><span class="p">,</span> <span class="n">losp</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">facelos</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LOS displacements&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_static_los_profile</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mf">110.</span><span class="p">,</span> <span class="mi">18</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">km</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="velocity_databases.html" title="Accessing crustal velocity databases"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="gf_store.html" title="Calculation of Green’s function databases"
             accesskey="P">previous</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, The Pyrocko Developers.
    </div>
  </body>
</html>